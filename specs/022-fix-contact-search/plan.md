# Implementation Plan: Fix Contact Search

**Branch**: `022-fix-contact-search` | **Date**: 2026-02-28 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/022-fix-contact-search/spec.md`

## Summary

Fix `ContactSearchRequest` and `SearchContactEntityResult` to match the C# source of truth. The request model must use a nested structure (`mainSearchRequest` + `loadOptions`) instead of flat pagination fields. The response model must declare all 22 fields from the C# `SearchContactEntityResult` entity with correct aliases. The mislabeled response fixture (containing `ContactDetailedInfo` data) must be replaced with a mock matching the actual search result shape.

## Technical Context

**Language/Version**: Python 3.11+ + pydantic>=2.0, requests (existing SDK)
**Primary Dependencies**: pydantic>=2.0, requests (no new deps)
**Storage**: Filesystem (fixture JSON files in `tests/fixtures/`)
**Testing**: pytest (non-live: `pytest -m "not live"`)
**Target Platform**: Python SDK (pip-installable library)
**Project Type**: single
**Constraints**: No fabricated fixtures; models must match C# source

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Pydantic Model Fidelity | PASS (after fix) | All C#-sourced fields with correct types, aliases, descriptions |
| II. Example-Driven Fixture Capture | PASS | Request fixture captured live; response mock from C# source |
| III. Four-Way Harmony | PASS (after fix) | Model + fixture/test + docs all updated |
| IV. Swagger-Informed, Reality-Validated | PASS | C# source (Tier 1) + swagger (Tier 3) cross-referenced |
| V. Endpoint Status Tracking | PASS | FIXTURES.md regenerated by route-driven sync |
| VI. Documentation Completeness | PASS (after fix) | docs/api/contacts.md updated |
| VII. Flywheel Evolution | N/A | Internal quality fix |
| VIII. Phase-Based Context Recovery | PASS | Single commit with all artifacts |
| IX. Endpoint Input Validation | PASS (after fix) | Request model uses extra="forbid", nested structure matches API |

## Project Structure

### Documentation (this feature)

```text
specs/022-fix-contact-search/
├── plan.md              # This file
├── research.md          # C# source analysis
├── data-model.md        # Field mapping
├── quickstart.md        # Verification steps
├── contracts/
│   └── contact-search.md  # Request/response contract
└── checklists/
    └── requirements.md  # Spec quality checklist
```

### Source Code (repository root)

```text
ab/api/models/
├── contacts.py          # EDIT — restructure ContactSearchRequest, rewrite SearchContactEntityResult
└── mixins.py            # REFERENCE — no longer used by ContactSearchRequest

tests/
├── models/
│   ├── test_contact_models.py   # EDIT — uncomment assert_no_extra_fields for search result
│   └── test_request_fixtures.py # REFERENCE — auto-discovers request fixtures
├── fixtures/
│   ├── requests/
│   │   └── ContactSearchRequest.json  # REFERENCE — already correct
│   ├── mocks/
│   │   └── SearchContactEntityResult.json  # CREATE — mock from C# schema
│   └── SearchContactEntityResult.json      # DELETE — mislabeled ContactDetailedInfo data

docs/api/
└── contacts.md          # EDIT — update search section
```

**Structure Decision**: Existing single-project layout. One new file (mock fixture), one deleted file (mislabeled fixture), rest are edits.

## Constitution Re-Check (Post-Design)

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Pydantic Model Fidelity | PASS | 22 response fields from C# source; nested request from swagger+fixture |
| II. Example-Driven Fixture Capture | PASS | Request fixture is live-captured; response mock matches C# exactly |
| III. Four-Way Harmony | PASS | Model + mock fixture + test + docs all accounted for |
| IV. Swagger-Informed, Reality-Validated | PASS | C# source primary; swagger confirms field names |
| V. Endpoint Status Tracking | PASS | Route-driven sync already in place |
| VI. Documentation Completeness | PASS | docs/api/contacts.md entry will have correct field references |
| VII. Flywheel Evolution | N/A | |
| VIII. Phase-Based Context Recovery | PASS | All changes in single commit; tasks checkboxed |
| IX. Endpoint Input Validation | PASS | ContactSearchRequest uses extra="forbid", sub-models validate nesting |

No violations. No complexity tracking needed.
