# Implementation Plan: CLI Gate Sweep

**Branch**: `026-cli-gate-sweep` | **Date**: 2026-03-01 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/026-cli-gate-sweep/spec.md`

## Summary

Two deliverables: (1) Clean up CLI method listing to hide route paths (show only in `--help`), and (2) systematically fix GET endpoints failing quality gates by adding missing constants, enabling auto-discovery of path parameters, handling "received extras" model mismatches, and implementing chain discovery for dependent IDs.

## Technical Context

**Language/Version**: Python 3.11+ (existing SDK)
**Primary Dependencies**: pydantic>=2.0, requests (existing SDK deps — no new dependencies)
**Storage**: Filesystem (fixture JSON files in `tests/fixtures/`)
**Testing**: pytest (existing test suite, 512 passing)
**Target Platform**: Linux/macOS CLI
**Project Type**: Single project (SDK + CLI)
**Performance Goals**: N/A — correctness sweep, not performance
**Constraints**: Must not break existing 512 passing tests
**Scale/Scope**: ~118 GET endpoints to evaluate, target fixing the most impactful ones

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Pydantic Model Fidelity | PASS | All model updates will follow ResponseModel/RequestModel conventions |
| II. Example-Driven Fixture Capture | PASS | Examples will use researched parameters from swagger and constants |
| III. Four-Way Harmony | PASS | Each fixed endpoint gets model + example + fixture + test updates |
| IV. Swagger-Informed, Reality-Validated | PASS | Models validated against captured fixtures, swagger used for field discovery |
| V. Endpoint Status Tracking | PASS | FIXTURES.md updated after each batch |
| VI. Documentation Completeness | DEFERRED | Sphinx updates out of scope for this sweep |
| VII. Flywheel Evolution | PASS | Gate improvements feed directly into progress report |
| VIII. Phase-Based Context Recovery | PASS | Work organized by endpoint group with checkpoint commits |
| IX. Endpoint Input Validation | PASS | Constants provide validated inputs; chain discovery ensures correct IDs |

No violations. Principle VI (Sphinx docs) is deferred — this sweep focuses on gates G1-G5, not documentation completeness.

## Project Structure

### Documentation (this feature)

```text
specs/026-cli-gate-sweep/
├── plan.md              # This file
├── research.md          # Gate failure analysis and fix patterns
├── quickstart.md        # Verification scenarios
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
ab/cli/
├── __main__.py          # US1: Remove route from _list_methods()
├── discovery.py         # Unchanged (MethodInfo already has route field)
└── parser.py            # Unchanged (print_method_help() already shows route)

tests/
├── constants.py         # US2: Add missing constants (TEST_HISTORY_AMOUNT, etc.)
└── fixtures/            # US2/US4: New/updated fixture JSON files

examples/
├── _runner.py           # US3: Chain discovery support (optional enhancement)
├── jobs.py              # US2: Fix get_tracking, get_tracking_v3 examples
└── *.py                 # US2: Fix other GET endpoint examples

ab/api/
├── models/              # US4: Fix "received extras" model mismatches
│   ├── jobs.py
│   ├── companies.py
│   └── ...
└── endpoints/           # Route definitions (mostly unchanged)
```

**Structure Decision**: Existing project structure. No new directories needed. Changes span models, examples, tests/constants, and CLI output formatting.

## Implementation Strategy

### Phase 1: CLI Listing Cleanup (US1)

Modify `_list_methods()` in `ab/cli/__main__.py`:
- Remove `path_col = f"{route.method} {route.path}"` from API Methods section
- Format API methods same as Helpers: `{name:<30} {params}{ret_str}`
- Sort API methods by name instead of route path
- Route info remains in `print_method_help()` (already implemented in parser.py line 181-182)

### Phase 2: Constants & Auto-Discovery (US2)

For each GET endpoint failing gates:
1. Check Route definition for path parameters (e.g., `{jobDisplayId}`, `{historyAmount}`)
2. Map each parameter to a constant using `path_param_to_constant()` (camelCase → TEST_SCREAMING_SNAKE)
3. If constant exists in `tests/constants.py` → use it
4. If constant doesn't exist → add it with an educated default value
5. Register the example in the appropriate `examples/*.py` file

**Constants to add** (based on research):
- `TEST_HISTORY_AMOUNT = 3` — for tracking v3 historyAmount parameter
- Additional constants discovered during sweep

### Phase 3: Chain Discovery (US3)

For endpoints requiring IDs not in constants (e.g., `rfqId`):
1. Call a parent listing endpoint using known constants (e.g., list RFQs for TEST_JOB_DISPLAY_ID)
2. Extract the needed ID from the response
3. Store as a constant for reuse
4. Use in the target endpoint call

### Phase 4: Model Fixes (US4)

For each "received extras" error:
1. Run the example, capture the error output
2. Identify extra fields from the error message
3. Check swagger definition for field types
4. Update the response model with correct fields and types
5. Re-run example to validate

### Endpoint Priority Order

Work through GET endpoints by endpoint group, prioritizing:
1. **jobs** — highest value, most endpoints (tracking, payment, parcel, timeline, notes, on-hold, SMS)
2. **companies** — commonly used
3. **contacts** — commonly used
4. **shipments** — rate quotes, accessorials
5. **catalog/sellers** — smaller surface
6. **remaining** — address, documents, settings, etc.

## Complexity Tracking

No constitution violations to justify.
